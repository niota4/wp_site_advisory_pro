(r=>{class e{constructor(){this.modal=null,this.isLoading=!1,this.currentScan=null,this.init()}init(){this.bindEvents(),this.setupModal()}bindEvents(){r(document).on("click","#wp-admin-bar-wsa-ai-detective a",e=>{e.preventDefault(),this.openModal()}),r(document).on("click",".wsa-detective-modal-close, .wsa-detective-modal-overlay",()=>{this.closeModal()}),r(document).on("click","#wsa-detective-submit",()=>{this.submitQuery("quick")}),r(document).on("click","#wsa-detective-deep-scan",()=>{this.submitQuery("deep")}),r(document).on("keydown","#wsa-detective-query",e=>{e.ctrlKey&&13===e.keyCode?this.submitQuery("quick"):e.altKey&&13===e.keyCode&&this.submitQuery("deep")}),r(document).on("keydown",e=>{27===e.keyCode&&this.modal&&this.modal.is(":visible")&&this.closeModal()}),r(document).on("click",".wsa-detective-action-btn",e=>{e=r(e.target).data("url");e&&window.open(e,"_blank")}),r(document).on("click",".wsa-detective-suggestion-btn",e=>{e=r(e.target).data("query");e&&(r("#wsa-detective-query").val(e),r("#wsa-detective-query").focus())}),r(document).on("click",".wsa-export-btn",e=>{this.handleExport(e)})}setupModal(){this.modal=r("#wsa-ai-detective-modal"),this.addResponsiveStyles()}openModal(){this.modal&&(this.modal.fadeIn(300),r("#wsa-detective-query").focus(),this.displayCurrentPageInfo())}closeModal(){this.modal&&(this.modal.fadeOut(300),this.resetModal())}displayCurrentPageInfo(){var e=wsaAiDetective.currentUrl,t=wsaAiDetective.pageId;let s=`<div class="wsa-detective-page-context">
                <h4><span class="dashicons dashicons-admin-page"></span> Current Page</h4>
                <p><strong>URL:</strong> ${e}</p>`;t&&(s+=`<p><strong>Page ID:</strong> ${t}</p>`),wsaAiDetective.isAdmin&&(s+="<p><strong>Context:</strong> WordPress Admin</p>"),s+="</div>",r(".wsa-detective-page-context").length||r(".wsa-detective-query-section").after(s)}submitQuery(e="quick"){var t;this.isLoading||(t=r("#wsa-detective-query").val().trim())&&(this.isLoading=!0,"quick"===e?this.performQuickScan(t):this.performDeepSearch(t))}performQuickScan(t){this.showQuickScanLoading(),this.analyzeDOMForQuery(t).then(e=>this.submitQuickScanQuery(t,e)).then(e=>{this.displayQuickResults(e),this.showDeepSearchOption(t)}).catch(e=>{console.error("Quick scan error:",e),this.showError("Quick scan failed: "+(e.message||"Unknown error"))}).finally(()=>{this.isLoading=!1,this.hideLoading()})}performDeepSearch(t){this.showDeepSearchLoading(),this.analyzeDOMForQuery(t).then(e=>this.submitDeepSearchQuery(t,e)).then(e=>{"initiated"===e.data.status?this.startDeepSearchTracking(e.data.scan_id):this.displayDeepSearchComplete(e.data)}).catch(e=>{console.error("Deep search error:",e),this.showError("Deep search failed: "+(e.message||"Unknown error"))}).finally(()=>{this.isLoading=!1})}analyzeDOMForQuery(e){return new Promise(t=>{try{t({matching_elements:this.findMatchingElements(e),page_structure:this.analyzePageStructure(),detected_frameworks:this.detectFrameworks(),navigation_analysis:this.analyzeNavigation(),content_analysis:this.analyzeContent()})}catch(e){t({error:"DOM analysis unavailable"})}})}findMatchingElements(e){let i=[];return this.extractSearchTerms(e).forEach(a=>{r("*").contents().filter(function(){return 3===this.nodeType&&r(this).text().toLowerCase().includes(a.toLowerCase())}).each(function(){var e=r(this).parent(),e={text:r(this).text().trim(),tag:e.prop("tagName")?.toLowerCase(),classes:e.attr("class")||"",id:e.attr("id")||"",selector:this.generateSelector(e[0]),parent_info:this.getParentInfo(e),attributes:this.getElementAttributes(e),match_type:"text_content",match_term:a,confidence:this.calculateMatchConfidence(a,r(this).text())};i.push(e)}.bind(this));["button","a",'input[type="button"]','input[type="submit"]','[role="button"]',".btn",".button"].forEach(s=>{r(s).each(function(){var e=r(this),t=e.text()||e.val()||e.attr("title")||e.attr("alt")||"";t.toLowerCase().includes(a.toLowerCase())&&i.push({text:t.trim(),tag:e.prop("tagName")?.toLowerCase(),classes:e.attr("class")||"",id:e.attr("id")||"",selector:this.generateSelector(e[0]),parent_info:this.getParentInfo(e),attributes:this.getElementAttributes(e),match_type:"interactive_element",match_term:a,confidence:this.calculateMatchConfidence(a,t),element_type:s})}.bind(this))})}),this.dedupAndSortMatches(i)}extractSearchTerms(e){let t=["the","a","an","is","are","where","what","how","button","link","menu","coming","from"];var s=(e.match(/"([^"]+)"/g)||[]).map(e=>e.replace(/"/g,"")),e=e.replace(/"[^"]+"/g,"").toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>2<e.length&&!t.includes(e));return[...s,...e]}generateSelector(e){if(!e)return"";let t=e.tagName.toLowerCase();return e.id?t+="#"+e.id:e.className&&0<(e=e.className.toString().split(" ").filter(e=>e)).length&&(t+="."+e.slice(0,3).join(".")),t}getParentInfo(e){e=e.parent();return{tag:e.prop("tagName")?.toLowerCase()||"",classes:e.attr("class")||"",id:e.attr("id")||"",selector:e.length?this.generateSelector(e[0]):""}}getElementAttributes(e){let s={},a=["href","src","data-*","aria-*","role","type","name"];return e[0]&&Array.from(e[0].attributes).forEach(t=>{a.some(e=>e.includes("*")?t.name.startsWith(e.replace("*","")):t.name===e)&&(s[t.name]=t.value)}),s}calculateMatchConfidence(e,t){var s,e=e.toLowerCase(),t=t.toLowerCase();return t===e?1:t.includes(e)?(s=e.length/t.length,Math.min(.9,.5+.4*s)):.7<(s=1-this.levenshteinDistance(e,t)/Math.max(e.length,t.length))?.6*s:0}levenshteinDistance(s,a){var i=Array(a.length+1).fill().map(()=>Array(s.length+1).fill(0));for(let e=0;e<=s.length;e++)i[0][e]=e;for(let e=0;e<=a.length;e++)i[e][0]=e;for(let t=1;t<=a.length;t++)for(let e=1;e<=s.length;e++){var n=s[e-1]===a[t-1]?0:1;i[t][e]=Math.min(i[t-1][e]+1,i[t][e-1]+1,i[t-1][e-1]+n)}return i[a.length][s.length]}dedupAndSortMatches(e){let t=new Set;return e.filter(e=>{e=e.selector+e.text;return!t.has(e)&&(t.add(e),!0)}).sort((e,t)=>{var s;return t.confidence!==e.confidence?t.confidence-e.confidence:((s={interactive_element:1,text_content:2})[e.match_type]||3)-(s[t.match_type]||3)}).slice(0,10)}extractQueryContext(e){var t={intent:"unknown",element_type:"unknown",action_needed:"locate"};let s=e.toLowerCase();s.includes("where")||s.includes("coming from")||s.includes("source")?t.intent="locate_source":s.includes("how")&&(s.includes("edit")||s.includes("change"))?(t.intent="edit_instructions",t.action_needed="edit"):s.includes("what")&&s.includes("control")&&(t.intent="identify_controller");var a,i;for([a,i]of Object.entries({button:["button","btn"],menu:["menu","navigation","nav"],header:["header","title"],footer:["footer"],sidebar:["sidebar","widget"],form:["form","input","field"],image:["image","img","photo"],text:["text","content","paragraph"]}))if(i.some(e=>s.includes(e))){t.element_type=a;break}return t}analyzePageStructure(){return{has_header:0<r("header, .header, #header").length,has_footer:0<r("footer, .footer, #footer").length,has_sidebar:0<r(".sidebar, #sidebar, .widget-area").length,has_navigation:0<r("nav, .nav, .navigation, .menu").length,main_content_selector:this.detectMainContent(),framework_classes:this.detectCSSFramework()}}detectMainContent(){var e;for(e of["main","#main",".main","#content",".content",".entry-content","article"])if(0<r(e).length)return e;return"body"}detectCSSFramework(){var e,t,s=[];for([e,t]of Object.entries({bootstrap:["container","row","col-","btn-"],foundation:["grid-container","grid-x","cell"],bulma:["columns","column","button"],tailwind:["flex","grid","text-"]}))t.some(e=>0<r(`.${e}, [class*="${e}"]`).length)&&s.push(e);return s}detectFrameworks(){var e={};return e.jquery=void 0!==window.jQuery,e.react=!!document.querySelector("[data-reactroot], [data-react-helmet]")||void 0!==window.React,e.vue=!!document.querySelector("[data-v-]")||void 0!==window.Vue,e.wordpress=!!document.querySelector('body[class*="wp-"], #wpadminbar')||void 0!==window.wp,e}analyzeNavigation(){let s=[];return r("nav, .nav, .navigation, .menu, ul.menu").each(function(){var e=r(this);let t={selector:this.generateSelector(e[0]),items:[],classes:e.attr("class")||"",id:e.attr("id")||""};e.find("a, button").each(function(){var e=r(this);t.items.push({text:e.text().trim(),href:e.attr("href")||"",classes:e.attr("class")||"",id:e.attr("id")||""})}),0<t.items.length&&s.push(t)}.bind(this)),s}analyzeContent(){return{headings:this.extractHeadings(),forms:this.analyzeForms(),images:this.analyzeImages(),widgets:this.analyzeWidgets()}}extractHeadings(){let t=[];return r("h1, h2, h3, h4, h5, h6").each(function(){var e=r(this);t.push({level:parseInt(e.prop("tagName").charAt(1)),text:e.text().trim(),selector:this.generateSelector(e[0]),classes:e.attr("class")||""})}.bind(this)),t}analyzeForms(){let s=[];return r("form").each(function(){var e=r(this);let t={action:e.attr("action")||"",method:e.attr("method")||"get",selector:this.generateSelector(e[0]),fields:[]};e.find("input, textarea, select, button").each(function(){var e=r(this);t.fields.push({type:e.attr("type")||e.prop("tagName").toLowerCase(),name:e.attr("name")||"",placeholder:e.attr("placeholder")||"",text:e.text()||e.val()||""})}),s.push(t)}.bind(this)),s}analyzeImages(){let t=[];return r("img").each(function(){var e=r(this);t.push({src:e.attr("src")||"",alt:e.attr("alt")||"",classes:e.attr("class")||"",selector:this.generateSelector(e[0])})}.bind(this)),t.slice(0,20)}analyzeWidgets(){let t=[];return r('.widget, [class*="widget"]').each(function(){var e=r(this);t.push({classes:e.attr("class")||"",id:e.attr("id")||"",title:e.find(".widget-title, h3, h4").first().text().trim(),selector:this.generateSelector(e[0])})}.bind(this)),t}scanPageSources(){return new Promise((t,a)=>{r.ajax({url:wsaAiDetective.ajaxUrl,type:"POST",data:{action:"wsa_ai_detective_scan",nonce:wsaAiDetective.nonce,pageUrl:wsaAiDetective.currentUrl,pageId:wsaAiDetective.pageId},success:e=>{e.success?t(e.data):a(new Error(e.data.message||"Scan failed"))},error:(e,t,s)=>{a(new Error("Network error: "+s))}})})}submitQuickScanQuery(e,s){return new Promise((t,a)=>{r.ajax({url:wsaAiDetective.ajaxUrl,type:"POST",data:{action:"wsa_ai_detective_query",nonce:wsaAiDetective.nonce,query:e,pageUrl:wsaAiDetective.currentUrl,pageId:wsaAiDetective.pageId,scanType:"quick",domAnalysis:JSON.stringify(s)},success:e=>{e.success?t(e):a(new Error(e.data.message||"Quick scan failed"))},error:(e,t,s)=>{a(new Error("Network error: "+s))}})})}submitDeepSearchQuery(e,s){return new Promise((t,a)=>{r.ajax({url:wsaAiDetective.ajaxUrl,type:"POST",data:{action:"wsa_ai_detective_query",nonce:wsaAiDetective.nonce,query:e,pageUrl:wsaAiDetective.currentUrl,pageId:wsaAiDetective.pageId,scanType:"deep",domAnalysis:JSON.stringify(s)},success:e=>{e.success?t(e):a(new Error(e.data.message||"Deep search failed"))},error:(e,t,s)=>{a(new Error("Network error: "+s))}})})}submitAIQuery(e,t){return this.submitQuickScanQuery(e,t)}showQuickScanLoading(){r("#wsa-detective-results, #wsa-detective-error").hide(),r("#wsa-detective-loading").show(),r(".wsa-detective-loading p").text("Quick scan in progress... (<5s)"),r("#wsa-detective-submit").prop("disabled",!0)}showDeepSearchLoading(){r("#wsa-detective-loading").show(),r(".wsa-detective-loading p").text("Initiating deep search... (5-10 minutes)"),this.createDeepSearchControls()}showLoading(){this.showQuickScanLoading()}hideLoading(){r("#wsa-detective-loading").hide(),r("#wsa-detective-submit").prop("disabled",!1)}startDeepSearchTracking(e){this.currentScan=e,this.createProgressInterface(),this.pollDeepSearchProgress()}createProgressInterface(){r("#wsa-detective-results").html(`
                <div class="wsa-deep-search-progress">
                    <h4><span class="dashicons dashicons-search"></span> Deep Search in Progress</h4>
                    <div class="wsa-progress-bar">
                        <div class="wsa-progress-fill" style="width: 0%"></div>
                        <span class="wsa-progress-text">0%</span>
                    </div>
                    <div class="wsa-current-task">Initializing...</div>
                    <div class="wsa-scan-controls">
                        <button class="button wsa-pause-scan">Pause</button>
                        <button class="button wsa-cancel-scan">Cancel</button>
                    </div>
                    <div class="wsa-partial-results">
                        <h5>Found So Far:</h5>
                        <div class="wsa-partial-results-list"></div>
                    </div>
                </div>
            `).show(),r(".wsa-pause-scan").on("click",()=>this.pauseDeepSearch()),r(".wsa-cancel-scan").on("click",()=>this.cancelDeepSearch())}pollDeepSearchProgress(){this.currentScan&&r.ajax({url:wsaAiDetective.ajaxUrl,type:"POST",data:{action:"wsa_ai_detective_deep_progress",nonce:wsaAiDetective.nonce,scanId:this.currentScan},success:e=>{e.success&&(this.updateProgressInterface(e.data),"in_progress"===e.data.status?setTimeout(()=>this.pollDeepSearchProgress(),3e3):"completed"===e.data.status?this.displayDeepSearchComplete(e.data):"error"===e.data.status&&this.showError("Deep search failed: "+e.data.error))},error:(e,t,s)=>{console.error("Progress polling failed:",s),setTimeout(()=>this.pollDeepSearchProgress(),5e3)}})}updateProgressInterface(e){r(".wsa-progress-fill").css("width",e.progress+"%"),r(".wsa-progress-text").text(e.progress+"%"),r(".wsa-current-task").text(e.current_task),e.results&&0<e.results.length&&this.updatePartialResults(e.results)}updatePartialResults(e){let t=r(".wsa-partial-results-list");t.empty(),e.slice(-5).forEach(e=>{e=r(`
                    <div class="wsa-partial-result-item">
                        <span class="result-type">${this.getResultTypeIcon(e.type)}</span>
                        <span class="result-description">${this.formatResultDescription(e)}</span>
                        <span class="confidence-badge">${Math.round(100*(e.confidence||0))}%</span>
                    </div>
                `);t.append(e)})}pauseDeepSearch(){this.controlDeepSearch("pause"),r(".wsa-pause-scan").text("Resume").removeClass("wsa-pause-scan").addClass("wsa-resume-scan"),r(".wsa-resume-scan").off("click").on("click",()=>this.resumeDeepSearch())}resumeDeepSearch(){this.controlDeepSearch("resume"),r(".wsa-resume-scan").text("Pause").removeClass("wsa-resume-scan").addClass("wsa-pause-scan"),r(".wsa-pause-scan").off("click").on("click",()=>this.pauseDeepSearch())}cancelDeepSearch(){confirm("Are you sure you want to cancel the deep search?")&&(this.controlDeepSearch("cancel"),this.currentScan=null,r("#wsa-detective-results").html("<p>Deep search cancelled.</p>"))}controlDeepSearch(t){r.ajax({url:wsaAiDetective.ajaxUrl,type:"POST",data:{action:"wsa_ai_detective_deep_control",nonce:wsaAiDetective.nonce,scanId:this.currentScan,action:t},success:e=>{e.success&&"resume"===t&&this.pollDeepSearchProgress()}})}displayResults(e){r("#wsa-detective-error").hide();var t,e=e.response||{};e.text&&(t=`
                    <div class="wsa-detective-response-wrapper ${this.getConfidenceClass(e.confidence||0)}">
                        <div class="wsa-detective-confidence-indicator">
                            <span class="confidence-score">Confidence: ${this.getConfidenceText(e.confidence||0)}</span>
                        </div>
                        <div class="wsa-detective-response-text">
                            ${this.formatResponse(e.text)}
                        </div>
                    </div>
                `,r("#wsa-detective-ai-response").html(t)),e.primary_source&&this.displayPrimarySource(e.primary_source),e.detected_elements&&0<e.detected_elements.length&&this.displayDetectedElements(e.detected_elements),e.alternative_sources&&0<e.alternative_sources.length&&this.displayAlternativeSources(e.alternative_sources),e.actions&&0<e.actions.length&&this.displayActions(e.actions),e.sources&&!e.primary_source&&this.displaySources(e.sources),r("#wsa-detective-results").show()}displayQuickResults(e){r("#wsa-detective-error").hide();var e=e.data,t=e.scan_time||"instant",t=(this.currentScan=e,`
                <div class="wsa-quick-scan-header">
                    <h4><span class="dashicons dashicons-performance"></span> Quick Scan Results</h4>
                    <div class="wsa-scan-meta">
                        <span class="scan-time">Completed in ${t}s</span>
                        <span class="confidence-indicator confidence-${this.getConfidenceClass(e.confidence)}">
                            Confidence: ${Math.round(100*(e.confidence||0))}%
                        </span>
                    </div>
                </div>
            `);let s=t;e.primary_source&&(s+=this.formatPrimarySource(e.primary_source,"quick")),s+=this.formatQuickScanResults(e.results),e.ai_analysis&&(s+=`
                    <div class="wsa-ai-analysis">
                        <h5><span class="dashicons dashicons-admin-comments"></span> AI Analysis</h5>
                        <div class="ai-response">${this.formatResponse(e.ai_analysis.analysis)}</div>
                    </div>
                `),s+=this.createExportOptions(e,"quick"),r("#wsa-detective-results").html(s).show()}showDeepSearchOption(e){0<r(".wsa-deep-search-option").length||(r("#wsa-detective-results").append(`
                <div class="wsa-deep-search-option">
                    <div class="wsa-deep-search-prompt">
                        <h5><span class="dashicons dashicons-search"></span> Want More Detailed Results?</h5>
                        <p>Run a Deep Search for comprehensive analysis of all theme files, plugins, database, and page builders.</p>
                        <div class="wsa-deep-search-controls">
                            <button class="button button-primary wsa-start-deep-search">
                                <span class="dashicons dashicons-admin-tools"></span>
                                Start Deep Search (5-10 min)
                            </button>
                            <div class="wsa-deep-search-info">
                                <small>Comprehensive analysis â€¢ Live progress updates â€¢ Cancellable anytime</small>
                            </div>
                        </div>
                    </div>
                </div>
            `),r(".wsa-start-deep-search").on("click",()=>{r(".wsa-deep-search-option").fadeOut(),this.performDeepSearch(e)}))}displayDeepSearchComplete(e){this.currentScan=e,r(".wsa-deep-search-progress").hide();var t=e.results.filter(e=>"ai_analysis"!==e.type);let s=`
                <div class="wsa-deep-search-complete">
                    <h4><span class="dashicons dashicons-yes-alt"></span> Deep Search Complete</h4>
                    <div class="wsa-scan-summary">
                        <span class="total-time">Completed in ${this.formatScanTime(e.scan_time)}</span>
                        <span class="total-results">${t.length} sources analyzed</span>
                    </div>
                </div>
            `;s+=this.formatDeepSearchResults(e.results);t=e.results.find(e=>"ai_analysis"===e.type);t&&t.analysis&&(s+=`
                    <div class="wsa-comprehensive-analysis">
                        <h5><span class="dashicons dashicons-admin-comments"></span> AI Recommendations</h5>
                        <div class="ai-response">${this.formatResponse(t.analysis)}</div>
                    </div>
                `),s+=this.createExportOptions(e,"deep"),r("#wsa-detective-results").html(s),r("#wsa-detective-results")[0].scrollIntoView({behavior:"smooth"})}formatQuickScanResults(s){let a='<div class="wsa-quick-results-grid">';return Object.keys(s).forEach(e=>{var t=s[e];t.found&&(t=t.matches||t.elements||[],a+=`
                        <div class="wsa-quick-result-card">
                            <h6><span class="dashicons dashicons-${this.getSourceIcon(e)}"></span> 
                                ${this.getSourceTypeLabel(e)}
                            </h6>
                            <div class="match-count">${t.length} found</div>
                            <div class="wsa-quick-matches">
                    `,t.slice(0,3).forEach(e=>{a+=`
                            <div class="quick-match-item">
                                <span class="match-text">${this.truncateText(this.getMatchText(e),40)}</span>
                                <span class="confidence-badge confidence-${this.getConfidenceClass(e.confidence||0)}">
                                    ${Math.round(100*(e.confidence||0))}%
                                </span>
                            </div>
                        `}),3<t.length&&(a+=`<div class="more-matches">+${t.length-3} more</div>`),a+="</div></div>")}),a+="</div>"}formatDeepSearchResults(e){let t=e;var a=e.find(e=>"ai_analysis"===e.type),a=(a&&a.prioritized_results&&(t=a.prioritized_results),e.find(e=>"branding_audit"===e.type));let i='<div class="wsa-prioritized-results">';a&&(i+=this.formatBrandingAudit(a));e=t.filter(e=>"ai_analysis"!==e.type&&"branding_audit"!==e.type);if(0===e.length&&!a)return'<div class="wsa-no-results">No relevant matches found.</div>';if(0!==e.length){a=e.slice(0,3),a=(0<a.length&&(i+=`
                    <div class="wsa-top-matches">
                        <h5><span class="dashicons dashicons-star-filled"></span> Best Matches</h5>
                `,a.forEach((e,t)=>{i+=this.formatPrimaryResultItem(e,t+1)}),i+="</div>"),e.slice(3));if(0<a.length){let s=this.groupResultsByType(a);i=(i+='<div class="wsa-additional-results">')+`<h6 class="additional-header">Additional Sources (${a.length})</h6>`,Object.keys(s).forEach(e=>{var t=s[e];0!==t.length&&(i=(i+='<div class="wsa-result-group">')+`<div class="group-header">${this.getSourceTypeLabel(e)} (${t.length})</div>`,t.forEach(e=>{i+=this.formatCompactResultItem(e)}),i+="</div>")}),i+="</div>"}}return i+="</div>"}formatPrimaryResultItem(e,t){var s=this.getCleanFileName(e.file||e.table||e.builder||e.type),a=Math.round(100*(e.confidence||0));let i=`
                <div class="wsa-primary-result-item">
                    <div class="primary-result-header">
                        <div class="result-rank">#${t}</div>
                        <div class="result-info">
                            <div class="result-title">
                                <span class="result-icon">${this.getResultTypeIcon(e.type)}</span>
                                <strong>${s}</strong>
                            </div>
                            <div class="result-confidence">
                                <span class="confidence-badge confidence-${this.getConfidenceClass(e.confidence||0)}">
                                    ${a}% Match
                                </span>
                            </div>
                        </div>
            `;return e.edit_link&&(i+=`
                    <div class="result-actions">
                        <a href="${e.edit_link}" class="wsa-edit-button" target="_blank">
                            <span class="dashicons dashicons-edit"></span> Edit
                        </a>
                    </div>
                `),i+="</div>",e.matches&&0<e.matches.length?(i+='<div class="result-details">',e.matches.slice(0,2).forEach(e=>{i+=`<div class="match-detail">Line ${e.line}: ${this.truncateText(e.content,100)}</div>`}),i+="</div>"):e.content_preview&&(i+=`<div class="result-details">${this.truncateText(e.content_preview,120)}</div>`),i+="</div>"}formatBrandingAudit(e){var t=e.consistency_score||0;let s=`
                <div class="wsa-branding-audit">
                    <div class="branding-audit-header">
                        <h5><span class="dashicons dashicons-admin-appearance"></span> Brand & CSS Audit</h5>
                        <div class="consistency-score ${80<=t?"excellent":60<=t?"good":40<=t?"fair":"poor"}">
                            <span class="score-label">Brand Consistency</span>
                            <span class="score-value">${t}/100</span>
                        </div>
                    </div>
            `;return e.color_palette&&(s+=this.formatColorPalette(e.color_palette)),e.typography&&(s+=this.formatTypographyAnalysis(e.typography)),e.recommendations&&(s+=this.formatBrandingRecommendations(e.recommendations)),e.brand_imagery&&(s+=this.formatBrandImagery(e.brand_imagery)),s+="</div>"}formatColorPalette(e){let s=`
                <div class="wsa-color-section">
                    <h6><span class="dashicons dashicons-art"></span> Color Palette</h6>
                    <div class="color-stats">
                        <span class="stat-item">
                            <strong>${e.color_statistics.total_unique_colors}</strong> unique colors
                        </span>
                        <span class="stat-item">
                            <strong>${Object.keys(e.primary_colors||{}).length}</strong> primary colors
                        </span>
                    </div>
            `;return e.primary_colors&&0<Object.keys(e.primary_colors).length&&(s+='<div class="primary-colors">',Object.values(e.primary_colors).slice(0,8).forEach(e=>{var t=e.total_frequency||0;s+=`
                        <div class="color-swatch" title="${e.color_name||e.hex}: Used ${t} times">
                            <div class="color-preview" style="background-color: ${e.hex}"></div>
                            <div class="color-info">
                                <div class="color-hex">${e.hex}</div>
                                <div class="color-usage">${t}x</div>
                            </div>
                        </div>
                    `}),s+="</div>"),s+="</div>"}formatTypographyAnalysis(e){let a=`
                <div class="wsa-typography-section">
                    <h6><span class="dashicons dashicons-editor-textcolor"></span> Typography</h6>
                    <div class="typography-stats">
                        <span class="stat-item">
                            <strong>${Object.keys(e.font_families||{}).length}</strong> font families
                        </span>
            `;var e=e.font_families||{},t=Object.values(e).filter(e=>e.google_font).length,s=Object.values(e).filter(e=>e.is_web_safe).length;return a+=`
                        <span class="stat-item">
                            <strong>${t}</strong> Google Fonts
                        </span>
                        <span class="stat-item">
                            <strong>${s}</strong> web-safe
                        </span>
                    </div>
            `,0<Object.keys(e).length&&(a+='<div class="font-families">',Object.values(e).slice(0,5).forEach(e=>{var t="Serif"===e.font_category?"editor-italic":"editor-paragraph",s=e.is_web_safe?"web-safe":e.google_font?"google-font":"custom-font";a+=`
                        <div class="font-family-item ${s}">
                            <div class="font-header">
                                <span class="dashicons dashicons-${t}"></span>
                                <strong>${e.primary_font}</strong>
                                <span class="font-category">${e.font_category}</span>
                            </div>
                            <div class="font-usage">Used ${e.usage_count} times</div>
                        </div>
                    `}),a+="</div>"),a+="</div>"}formatBrandingRecommendations(e){if(0===[...e.color_recommendations||[],...e.typography_recommendations||[],...e.design_recommendations||[]].length)return'<div class="wsa-recommendations-section"><div class="no-recommendations">âœ… No major branding issues found!</div></div>';let s=`
                <div class="wsa-recommendations-section">
                    <h6><span class="dashicons dashicons-lightbulb"></span> Recommendations</h6>
            `;return e.priority_actions&&0<e.priority_actions.length&&(s+='<div class="priority-actions">',e.priority_actions.forEach(e=>{var t="high"===e.priority?"warning":"medium"===e.priority?"info":"flag";s+=`
                        <div class="recommendation-item priority-${e.priority}">
                            <div class="rec-icon"><span class="dashicons dashicons-${t}"></span></div>
                            <div class="rec-content">
                                <strong>${e.title}</strong>
                                <p>${e.description}</p>
                                <div class="rec-action">${e.action}</div>
                            </div>
                        </div>
                    `}),s+="</div>"),s+="</div>"}formatBrandImagery(e){let t=`
                <div class="wsa-imagery-section">
                    <h6><span class="dashicons dashicons-format-image"></span> Brand Assets</h6>
            `;var s;return e.custom_logo&&(s=e.custom_logo,t+=`
                    <div class="brand-asset">
                        <div class="asset-type">Custom Logo</div>
                        <div class="asset-info">
                            ${s.width}Ã—${s.height}px
                            ${s.file_size?"â€¢ "+this.formatFileSize(s.file_size):""}
                        </div>
                        <a href="${s.edit_link}" class="asset-edit-link" target="_blank">
                            <span class="dashicons dashicons-edit"></span> Edit
                        </a>
                    </div>
                `),e.favicons&&0<e.favicons.length&&(t+=`
                    <div class="brand-asset">
                        <div class="asset-type">Favicons</div>
                        <div class="asset-info">${e.favicons.length} favicon files detected</div>
                    </div>
                `),e.icon_fonts&&0<e.icon_fonts.length&&(t+=`
                    <div class="brand-asset">
                        <div class="asset-type">Icon Fonts</div>
                        <div class="asset-info">
                            ${e.icon_fonts.map(e=>e.type).join(", ")}
                        </div>
                    </div>
                `),t+="</div>"}formatCompactResultItem(e){let t=`
                <div class="wsa-compact-result-item">
                    <div class="compact-result-info">
                        <span class="compact-title">${this.getCleanFileName(e.file||e.table||e.builder||e.type)}</span>
                        <span class="compact-confidence">${Math.round(100*(e.confidence||0))}%</span>
            `;return e.edit_link&&(t+=`<a href="${e.edit_link}" class="compact-edit-link" target="_blank">Edit</a>`),t+="</div>",e.matches&&0<e.matches.length&&(e=e.matches[0],t+=`<div class="compact-match">Line ${e.line}: ${this.truncateText(e.content,60)}</div>`),t+="</div>"}formatDeepResultItem(e){return this.formatCompactResultItem(e)}getCleanFileName(e){if(!e)return"Unknown Source";let t=e.replace(/.*\/packaged\/[^\/]+\//,"");return 40<(t=t.replace(/^theme\/\//,"")).length?(e=t.split("/"))[e.length-1]:t}createExportOptions(e,t="deep"){var s=r("#wsa-detective-query").val()||"site-analysis";return`
                <div class="wsa-export-options">
                    <h5><span class="dashicons dashicons-download"></span> Export Results</h5>
                    <div class="export-buttons">
                        <button class="button wsa-export-btn" data-format="csv" data-scan-type="${t}" data-query="${s}">
                            <span class="dashicons dashicons-media-spreadsheet"></span> Export CSV
                        </button>
                        <button class="button wsa-export-btn" data-format="json" data-scan-type="${t}" data-query="${s}">
                            <span class="dashicons dashicons-media-code"></span> Export JSON
                        </button>
                    </div>
                    <div class="export-status" style="display: none;"></div>
                </div>
            `}getResultTypeIcon(e){return{theme_file:"ðŸ“„",plugin:"ðŸ”Œ",database:"ðŸ’¾",page_builder:"ðŸŽ¨",menu_item:"ðŸ“",widget:"ðŸ§©"}[e]||"ðŸ“„"}formatResultDescription(e){switch(e.type){case"theme_file":return"Found in "+(e.file||"theme file");case"plugin":return"Found in "+(e.plugin||"plugin");case"database":return"Found in "+(e.table||"database");case"page_builder":return"Found in "+(e.builder||"page builder");default:return e.description||"Match found"}}getSourceTypeLabel(e){return{dom_matches:"DOM Elements",menu_matches:"WordPress Menus",template_matches:"Theme Templates",widget_matches:"Widgets",shortcode_matches:"Shortcodes",theme_file:"Theme Files",plugin:"Plugins",database:"Database",page_builder:"Page Builders"}[e]||e.replace("_"," ").replace(/\b\w/g,e=>e.toUpperCase())}getMatchText(e){return e.text||e.title||e.item_title||e.shortcode||e.content||"Match found"}groupResultsByType(e){let s={};return e.forEach(e=>{var t=e.type||"unknown";s[t]||(s[t]=[]),s[t].push(e)}),s}formatScanTime(e){return 60<e?Math.floor(e/60)+`m ${Math.round(e%60)}s`:Math.round(e)+"s"}truncateText(e,t){return e.length<=t?e:e.substr(0,t)+"..."}createDeepSearchControls(){return!0}formatPrimarySource(e,t="quick"){var s=this.getConfidenceClass(e.confidence||0);return`
                <div class="wsa-detective-primary-source ${t}-scan">
                    <h4 class="primary-source-header">
                        <span class="dashicons dashicons-star-filled"></span>
                        Primary Source Found (${"quick"===t?"Quick Scan":"Deep Search"})
                    </h4>
                    <div class="wsa-detective-source-item wsa-detective-source-${e.type||"unknown"} primary ${s}">
                        <div class="wsa-detective-source-header">
                            <span class="dashicons dashicons-${this.getSourceIcon(e.type||"unknown")}"></span>
                            <strong>${e.name||e.type||"Source Found"}</strong>
                            ${e.edit_link?`<a href="${e.edit_link}" class="wsa-detective-edit-link button-primary" target="_blank">
                                <span class="dashicons dashicons-edit"></span> Edit Now
                            </a>`:""}
                        </div>
                        <div class="wsa-detective-source-description">
                            ${e.description||e.location||"Source identified with high confidence"}
                        </div>
                        ${e.details?`<div class="wsa-detective-source-details">${e.details}</div>`:""}
                    </div>
                </div>
            `}bindExportEvents(){r(document).on("click",".wsa-export-csv",e=>{e=JSON.parse(r(e.target).data("results"));this.exportToCsv(e)}),r(document).on("click",".wsa-export-json",e=>{e=JSON.parse(r(e.target).data("results"));this.exportToJson(e)})}exportToCsv(e){let t=[["Type","Source","Confidence","Description"]];e.forEach(e=>{t.push([e.type||"Unknown",e.file||e.table||e.builder||e.source||"N/A",Math.round(100*(e.confidence||0))+"%",this.formatResultDescription(e)])});e=t.map(e=>e.map(e=>`"${e}"`).join(",")).join("\n");this.downloadFile(e,"site-detective-results.csv","text/csv")}exportToJson(e){e=JSON.stringify({export_date:(new Date).toISOString(),site_url:window.location.href,results:e},null,2);this.downloadFile(e,"site-detective-results.json","application/json")}downloadFile(e,t,s){e=new Blob([e],{type:s}),s=window.URL.createObjectURL(e),e=document.createElement("a");e.href=s,e.download=t,document.body.appendChild(e),e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(s)}init(){this.bindEvents(),this.bindExportEvents(),this.setupModal()}displaySources(e){let a=r("#wsa-detective-sources-list");a.empty(),e&&0!==e.length?e.forEach(e=>{var t=this.getSourceIcon(e.type),s=e.edit_link?`<a href="${e.edit_link}" target="_blank" class="wsa-detective-edit-link">
                        <span class="dashicons dashicons-edit"></span> Edit
                    </a>`:"",t=`
                    <div class="wsa-detective-source-item wsa-detective-source-${e.type}">
                        <div class="wsa-detective-source-header">
                            <span class="dashicons dashicons-${t}"></span>
                            <strong>${e.title}</strong>
                            ${s}
                        </div>
                        <div class="wsa-detective-source-description">
                            ${e.description}
                        </div>
                    </div>
                `;a.append(t)}):a.html("<p>"+wsaAiDetective.strings.noResults+"</p>")}displayActions(e){let s=r("#wsa-detective-actions-list");s.empty(),e&&0!==e.length?e.forEach(e=>{var t=e.icon||"admin-tools",t=`
                    <button class="wsa-detective-action-btn button" data-url="${e.url}">
                        <span class="dashicons dashicons-${t}"></span>
                        ${e.title}
                    </button>
                `;s.append(t)}):s.html("<p>No quick actions available.</p>")}displayPrimarySource(e){var t,s,a=r("#wsa-detective-sources-list");e?(s=this.getSourceIcon(e.type),t=e.edit_link?`<a href="${e.edit_link}" target="_blank" class="wsa-detective-edit-link button-primary">
                    <span class="dashicons dashicons-edit"></span> Edit Now
                </a>`:"",s=`
                <div class="wsa-detective-primary-source">
                    <h4 class="primary-source-header">
                        <span class="dashicons dashicons-star-filled"></span>
                        Primary Source Found
                    </h4>
                    <div class="wsa-detective-source-item wsa-detective-source-${e.type} primary">
                        <div class="wsa-detective-source-header">
                            <span class="dashicons dashicons-${s}"></span>
                            <strong>${e.name||e.type}</strong>
                            ${t}
                        </div>
                        <div class="wsa-detective-source-description">
                            ${e.location||e.description||"Source identified with high confidence"}
                        </div>
                        ${e.details?`<div class="wsa-detective-source-details">${e.details}</div>`:""}
                    </div>
                </div>
            `,a.html(s)):a.html("<p>No primary source identified.</p>")}displayDetectedElements(e){if(e&&0!==e.length){var s=r('<div class="wsa-detective-detected-elements"></div>');s.append('<h4><span class="dashicons dashicons-search"></span> Detected Elements</h4>');let t=r('<div class="wsa-detective-elements-list"></div>');e.forEach(e=>{e=`
                    <div class="wsa-detective-element ${this.getConfidenceClass(e.confidence||0)}">
                        <div class="element-selector">
                            <code>${e.selector}</code>
                            <span class="confidence-badge">${Math.round(100*(e.confidence||0))}%</span>
                        </div>
                        ${e.text?`<div class="element-text">"${e.text}"</div>`:""}
                        ${e.type?`<div class="element-type">Type: ${e.type}</div>`:""}
                    </div>
                `;t.append(e)}),s.append(t),r("#wsa-detective-sources-list").append(s)}}displayAlternativeSources(e){if(e&&0!==e.length){var t=r('<div class="wsa-detective-alternative-sources"></div>');t.append('<h4><span class="dashicons dashicons-list-view"></span> Alternative Sources</h4>');let a=r('<div class="wsa-detective-alternatives-list"></div>');e.forEach(e=>{var t=this.getSourceIcon(e.type),s=e.edit_link?`<a href="${e.edit_link}" target="_blank" class="wsa-detective-edit-link button">
                        <span class="dashicons dashicons-edit"></span> Edit
                    </a>`:"",t=`
                    <div class="wsa-detective-source-item wsa-detective-source-${e.type} alternative">
                        <div class="wsa-detective-source-header">
                            <span class="dashicons dashicons-${t}"></span>
                            <strong>${e.name||e.type}</strong>
                            ${s}
                        </div>
                        <div class="wsa-detective-source-description">
                            ${e.location||e.description}
                        </div>
                    </div>
                `;a.append(t)}),t.append(a),r("#wsa-detective-sources-list").append(t)}}getConfidenceClass(e){return.8<=e?"confidence-high":.6<=e?"confidence-medium":.4<=e?"confidence-low":"confidence-very-low"}getConfidenceText(e){return.9<=e?"Very High (90%+)":.8<=e?"High (80%+)":.7<=e?"Good (70%+)":.6<=e?"Moderate (60%+)":.4<=e?"Low (40%+)":"Very Low ("+Math.round(100*e)+"%)"}showError(e){r("#wsa-detective-results, #wsa-detective-loading").hide(),r("#wsa-detective-error p").text(e),r("#wsa-detective-error").show()}resetModal(){r("#wsa-detective-query").val(""),r("#wsa-detective-results, #wsa-detective-loading, #wsa-detective-error").hide(),r(".wsa-detective-page-context").remove(),this.isLoading=!1}formatResponse(e){let t=e.replace(/\n\n/g,"</p><p>");return t=(t=(t="<p>"+t+"</p>").replace(/([a-zA-Z0-9_-]+\.php)/g,"<strong>$1</strong>")).replace(/([a-zA-Z_][a-zA-Z0-9_]*\(\))/g,"<code>$1</code>")}getSourceIcon(e){return{theme:"admin-appearance",plugin:"admin-plugins",builder:"layout",meta:"admin-settings",template:"admin-page"}[e]||"admin-generic"}addResponsiveStyles(){r("#wsa-detective-responsive-styles").length||r('<style id="wsa-detective-responsive-styles">').text(`
                        @media (max-width: 768px) {
                            .wsa-detective-modal-container {
                                width: 95%;
                                height: 90%;
                                margin: 2.5% auto;
                            }
                            
                            #wsa-detective-query {
                                font-size: 16px; /* Prevent zoom on iOS */
                            }
                            
                            .wsa-detective-source-item {
                                margin-bottom: 15px;
                            }
                            
                            .wsa-detective-action-btn {
                                display: block;
                                width: 100%;
                                margin-bottom: 10px;
                            }
                        }
                    `).appendTo("head")}handleExport(e){e.preventDefault();let t=r(e.currentTarget);var e=t.data("format"),s=t.data("scan-type"),a=t.data("query");let i=r(".export-status");var n=this.collectCurrentResults();n&&0!==n.length?(t.prop("disabled",!0),i.html('<span class="loading">Generating export file...</span>').show(),r.ajax({url:wsaAiDetective.ajaxUrl,type:"POST",data:{action:"wsa_ai_detective_export",nonce:wsaAiDetective.nonce,results:n,format:e,scanType:s,query:a},success:e=>{var t;e.success?(t=`
                            <span class="success">
                                Export completed! 
                                <a href="${e.data.download_url}" target="_blank" download="${e.data.filename}">
                                    Download ${e.data.filename} (${e.data.file_size})
                                </a>
                            </span>
                        `,i.html(t),window.open(e.data.download_url,"_blank")):i.html(`<span class="error">Export failed: ${e.data.message}</span>`)},error:(e,t,s)=>{i.html(`<span class="error">Export failed: ${s}</span>`)},complete:()=>{t.prop("disabled",!1),setTimeout(()=>{i.fadeOut()},1e4)}})):i.html('<span class="error">No results to export</span>').show()}collectCurrentResults(){let t=[];return this.currentScan&&this.currentScan.results?this.currentScan.results:(r(".wsa-detective-source-item").each(function(){var e=r(this),e={type:e.data("type")||"unknown",file:e.find(".source-file").text()||"",matches:[{line:e.find(".line-number").text()||"",content:e.find(".source-content").text()||"",context:e.find(".source-description").text()||""}],confidence:parseFloat(e.data("confidence"))||0,edit_link:e.find(".wsa-detective-action-btn").attr("href")||""};t.push(e)}),t)}formatFileSize(e){var t;return 0===e?"0 Bytes":(t=Math.floor(Math.log(e)/Math.log(1024)),parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["Bytes","KB","MB","GB"][t])}}r(document).ready(function(){"undefined"!=typeof wsaAiDetective&&(window.wsaDetectiveInstance=new e)}),window.WSADetective={openModal:function(){window.wsaDetectiveInstance&&window.wsaDetectiveInstance.openModal()},askQuestion:function(e){window.wsaDetectiveInstance&&(window.wsaDetectiveInstance.openModal(),setTimeout(()=>{r("#wsa-detective-query").val(e)},300))}}})(jQuery);
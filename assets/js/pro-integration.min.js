(o=>{class e{constructor(){this.init()}init(){this.bindEvents(),this.initFeatures(),this.initTabBindings(),this.updateLocalhostMessage(),this.initPersistedData()}initTabBindings(){o(document).on("wsa:tabChanged",(e,s)=>{["overview","system","ai-conflicts","pro-reports","ai-assistant"].includes(s)&&setTimeout(()=>{this.bindEvents()},100)})}bindEvents(){o(document).off("click.wsa-pro").on("click.wsa-pro","#wsa-run-vulnerability-scan",e=>{e.preventDefault(),this.runVulnerabilityScann()}),o(document).off("click.wsa-pro-vuln-report").on("click.wsa-pro-vuln-report","#wsa-view-vulnerability-report",e=>{e.preventDefault(),this.viewVulnerabilityReport()}),o(document).off("click.wsa-pro-perf").on("click.wsa-pro-perf","#wsa-run-pagespeed-analysis",e=>{e.preventDefault(),this.runPageSpeedAnalysis()}),o(document).off("click.wsa-pro-perf-report").on("click.wsa-pro-perf-report","#wsa-view-performance-report",e=>{e.preventDefault(),this.viewPerformanceReport()}),o(document).off("click.wsa-pro-ai-insights").on("click.wsa-pro-ai-insights","#wsa-get-ai-insights",e=>{e.preventDefault(),this.getAIInsights()}),o(document).off("click.wsa-pro-conflict").on("click.wsa-pro-conflict","#wsa-run-conflict-check",e=>{e.preventDefault(),this.runConflictCheck()}),o(document).off("click.wsa-pro-conflict-report").on("click.wsa-pro-conflict-report","#wsa-view-conflict-report",e=>{e.preventDefault(),this.viewConflictAnalysis()}),o(document).off("click.wsa-pro-reports").on("click.wsa-pro-reports","#wsa-generate-pdf-report",e=>{e.preventDefault(),this.generateProReport()}),o(document).off("click.wsa-pro-download").on("click.wsa-pro-download","#wsa-download-latest-report",e=>{e.preventDefault(),this.scheduleReport()}),o(document).off("click.wsa-pro-chat").on("click.wsa-pro-chat","#wsa-ask-question",e=>{e.preventDefault(),this.openAIChat()}),o(document).off("click.wsa-pro-chat-history").on("click.wsa-pro-chat-history","#wsa-view-chat-history",e=>{e.preventDefault(),this.viewChatHistory()})}initFeatures(){this.updateProStats(),setInterval(()=>{this.updateProStats()},3e4)}runVulnerabilityScann(){let e=o("#wsa-run-vulnerability-scan"),s=o("#wsa-vulnerability-results");e.prop("disabled",!0).text("Scanning..."),s.hide(),o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_run_vulnerability_scan",nonce:wsa_pro_admin.nonce},success:e=>{e.success?(s.html("<h4>Vulnerability Scan Complete</h4><p>"+e.data.message+"</p>").show(),this.updateProStats()):s.html('<div class="notice notice-error"><p>'+(e.data||"Scan failed")+"</p></div>").show()},error:()=>{s.html('<div class="notice notice-error"><p>Failed to run vulnerability scan. Please try again.</p></div>').show()},complete:()=>{e.prop("disabled",!1).text("Run Vulnerability Scan")}})}viewVulnerabilityReport(){let s=o("#wsa-vulnerability-results");o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_get_vulnerability_report",nonce:wsa_pro_admin.nonce},success:e=>{e.success?this.displayVulnerabilityReport(e.data,s):s.html('<div class="notice notice-warning"><p>No vulnerability report available. Run a scan first.</p></div>').show()},error:()=>{s.html('<div class="notice notice-error"><p>Failed to load vulnerability report.</p></div>').show()}})}displayVulnerabilityReport(e,s){let a="<h4>Vulnerability Report</h4>";e.summary&&0<e.summary.total_vulnerabilities?a=(a=(a=(a=(a+='<div class="wsa-vulnerability-summary">')+"<p><strong>Total Vulnerabilities Found: "+e.summary.total_vulnerabilities+"</strong></p>")+"<p>Core: "+(e.summary.core_vulnerabilities||0)+" | ")+"Plugins: "+(e.summary.plugin_vulnerabilities||0)+" | ")+"Themes: "+(e.summary.theme_vulnerabilities||0)+"</p></div>":a+='<div class="notice notice-success"><p>No vulnerabilities found! Your site is secure.</p></div>',s.html(a).show()}runPageSpeedAnalysis(){let e=o("#wsa-run-pagespeed-analysis"),t=o("#wsa-performance-results");var s;"undefined"==typeof wsa_pro_admin?console.error("wsa_pro_admin object not found!"):(s=o("#wsa-performance-url").val())&&(!s.includes("localhost")&&!s.includes("127.0.0.1")||confirm("This appears to be a localhost URL. PageSpeed Insights requires a publicly accessible URL. Do you want to continue anyway?"))&&(e.prop("disabled",!0).text("Analyzing..."),t.html('<div class="notice notice-info"><p><span class="spinner is-active" style="float: left; margin-right: 10px;"></span>Running PageSpeed Insights analysis for: <strong>'+s+"</strong><br>This may take 30-60 seconds.</p></div>").show(),o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_run_pagespeed_analysis",nonce:wsa_pro_admin.nonce,url:s},success:s=>{if(s.success){this.latestPerformanceData=s.data;let e='<div class="notice notice-success inline" style="margin: 10px 0; padding: 8px 12px;">';e=e+"<p><strong>âœ… Analysis Complete!</strong> Results will open automatically in a popup...</p>"+"</div>",s.data&&"lighthouse_simulation"===s.data.source&&(e='<div class="notice notice-info inline" style="margin: 10px 0; padding: 8px 12px;">',e=(e+="<p><strong>ðŸš€ Lighthouse Simulation Complete!</strong> ")+"Local development analysis finished. Results opening in popup...</p></div>"),t.html(e).show(),o("#wsa-view-performance-report").show(),s.data&&s.data.summary&&this.updatePerformanceMetrics(s.data.summary),this.updateProStats(),setTimeout(()=>{this.showPerformanceModal(s.data)},800)}else t.html('<div class="notice notice-error"><p>'+(s.data||"Analysis failed")+"</p></div>").show()},error:(e,s,a)=>{console.error("AJAX error:",e,s,a),t.html('<div class="notice notice-error"><p>Failed to run performance analysis. Please check your PageSpeed Insights API key configuration.</p></div>').show()},complete:()=>{e.prop("disabled",!1).text("Run Performance Analysis")}}))}viewPerformanceReport(){if(this.latestPerformanceData)this.showPerformanceModal(this.latestPerformanceData);else{var e=localStorage.getItem("wsa_last_performance_data");if(e)try{var s=JSON.parse(e);return void this.showPerformanceModal(s)}catch(e){console.error("Error parsing persisted data:",e)}o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_get_performance_report",nonce:wsa_pro_admin.nonce},success:e=>{e.success?this.showPerformanceModal(e.data):this.showModalError("No performance report available. Run an analysis first.")},error:(e,s,a)=>{console.error("AJAX error:",e,s,a),this.showModalError("Error loading performance report.")}})}}displayPerformanceReport(e,s){s.html('<div class="notice notice-info"><p><strong>âœ¨ Results Ready!</strong> Performance analysis complete. Results are displayed in the popup modal. <a href="#" id="wsa-reopen-modal" class="button button-small">View Results Again</a></p></div>').show(),o("#wsa-reopen-modal").off("click").on("click",e=>{e.preventDefault(),this.viewPerformanceReport()})}updatePerformanceMetrics(s){if(s&&s.scores&&"object"==typeof s.scores){o("#wsa-performance-metrics").show();let e=null;s.scores.performance&&void 0!==s.scores.performance.score?e=s.scores.performance.score:s.scores.mobile&&s.scores.mobile.performance?e=s.scores.mobile.performance.score:s.scores.desktop&&s.scores.desktop.performance&&(e=s.scores.desktop.performance.score),null!==e&&o("#wsa-perf-score").text(e+"/100"),s.core_web_vitals&&(s.core_web_vitals.fcp&&o("#wsa-fcp").text(s.core_web_vitals.fcp+"s"),s.core_web_vitals.lcp&&o("#wsa-lcp").text(s.core_web_vitals.lcp+"s"),s.core_web_vitals.tbt)&&o("#wsa-tbt").text(s.core_web_vitals.tbt+"ms")}else s&&s.scores&&0<s.scores.length?(o("#wsa-performance-metrics").show(),s.scores.desktop&&s.scores.desktop.performance&&o("#wsa-perf-score").text(s.scores.desktop.performance.score+"/100"),s.core_web_vitals&&(s.core_web_vitals.fcp&&o("#wsa-fcp").text(s.core_web_vitals.fcp+"s"),s.core_web_vitals.lcp&&o("#wsa-lcp").text(s.core_web_vitals.lcp+"s"),s.core_web_vitals.tbt)&&o("#wsa-tbt").text(s.core_web_vitals.tbt+"ms")):o("#wsa-performance-metrics").hide()}getAIInsights(){let e=o("#wsa-get-ai-insights"),a=o("#wsa-performance-results");e.prop("disabled",!0).text("Getting AI Insights..."),o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_get_ai_performance_insights",nonce:wsa_pro_admin.nonce},success:e=>{var s;e.success?(s='<div class="wsa-ai-insights"><h4>AI Performance Recommendations</h4><div class="wsa-insights-content">'+e.data.content.replace(/\n/g,"<br>")+"</div></div>",a.append(s)):a.append('<div class="notice notice-error"><p>'+(e.data||"Failed to get AI insights")+"</p></div>")},error:()=>{a.append('<div class="notice notice-error"><p>Failed to get AI insights. Please check your OpenAI API key.</p></div>')},complete:()=>{e.prop("disabled",!1).text("Get AI Recommendations")}})}runConflictCheck(){var e=o("#wsa-run-conflict-check"),s=o("#wsa-conflict-results");e.prop("disabled",!0).text("Checking..."),s.hide(),this.viewConflictAnalysis(),e.prop("disabled",!1).text("Check for Conflicts")}viewConflictAnalysis(){let s=o("#wsa-conflict-results");o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_get_conflict_analysis",nonce:wsa_pro_admin.nonce},success:e=>{e.success?this.displayConflictAnalysis(e.data,s):s.html('<div class="notice notice-info"><p>No conflicts detected. Your plugins and themes are working well together.</p></div>').show()},error:()=>{s.html('<div class="notice notice-error"><p>Failed to load conflict analysis.</p></div>').show()}})}displayConflictAnalysis(e,s){let a="<h4>Conflict Analysis</h4>";e.conflicts&&0<e.conflicts.length?(a+='<div class="wsa-conflicts-list">',e.conflicts.forEach(e=>{a=(a=(a+='<div class="wsa-conflict-item">')+"<strong>"+e.source+"</strong>")+"<p>"+e.description+"</p>",e.ai_analysis&&(a+='<div class="wsa-ai-suggestion">'+e.ai_analysis+"</div>"),a+="</div>"}),a+="</div>"):a+='<div class="notice notice-success"><p>No conflicts detected! Your site is running smoothly.</p></div>',s.html(a).show()}generateProReport(){let e=o("#wsa-generate-pro-report"),s=o("#wsa-report-results");e.prop("disabled",!0).text("Generating..."),s.hide(),o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_generate_pro_report",nonce:wsa_pro_admin.nonce},success:e=>{(e.success?s.html('<h4>Report Generated</h4><p>Your professional report has been generated successfully.</p><p><a href="'+e.data.download_url+'" class="button">Download PDF</a></p>'):s.html('<div class="notice notice-error"><p>'+(e.data||"Report generation failed")+"</p></div>")).show()},error:()=>{s.html('<div class="notice notice-error"><p>Failed to generate report. Please try again.</p></div>').show()},complete:()=>{e.prop("disabled",!1).text("Generate Report")}})}previewProReport(){window.open(wsa_pro_admin.ajax_url+"?action=wsa_preview_pro_report&nonce="+wsa_pro_admin.nonce,"_blank")}sendTestReport(){let e=o("#wsa-send-test-report"),s=o("#wsa-report-results");e.prop("disabled",!0).text("Sending..."),o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_send_test_report",nonce:wsa_pro_admin.nonce},success:e=>{(e.success?s.html('<div class="notice notice-success"><p>Test report sent successfully!</p></div>'):s.html('<div class="notice notice-error"><p>'+(e.data||"Failed to send test report")+"</p></div>")).show()},error:()=>{s.html('<div class="notice notice-error"><p>Failed to send test report. Please check your email settings.</p></div>').show()},complete:()=>{e.prop("disabled",!1).text("Send Test Email")}})}scheduleReport(){var e=o("#wsa-report-frequency").val();let s=o("#wsa-schedule-report"),a=o("#wsa-report-results");s.prop("disabled",!0).text("Updating..."),o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_schedule_report",frequency:e,nonce:wsa_pro_admin.nonce},success:e=>{(e.success?a.html('<div class="notice notice-success"><p>Report schedule updated successfully!</p></div>'):a.html('<div class="notice notice-error"><p>'+(e.data||"Failed to update schedule")+"</p></div>")).show()},error:()=>{a.html('<div class="notice notice-error"><p>Failed to update report schedule.</p></div>').show()},complete:()=>{s.prop("disabled",!1).text("Update Schedule")}})}updateProStats(){o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_get_vulnerability_report",nonce:wsa_pro_admin.nonce},success:e=>{e.success&&e.data.summary&&(e=0<(e=e.data.summary.total_vulnerabilities||0)?'<span class="wsa-status-disconnected">'+e+" Vulnerabilities</span>":'<span class="wsa-status-connected">No Vulnerabilities</span>',o("#wsa-pro-vulnerability-status").html(e))}}),o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_get_performance_report",nonce:wsa_pro_admin.nonce},success:s=>{if(s.success&&s.data.summary&&s.data.summary.scores){s=s.data.summary.scores;if(s.mobile&&s.mobile.performance){s=s.mobile.performance.score;let e="wsa-status-connected";s<50?e="wsa-status-disconnected":s<90&&(e="wsa-status-warning");s='<span class="'+e+'">'+s+"/100</span>";o("#wsa-pro-performance-status").html(s)}}}})}openAIChat(){"undefined"!=typeof WSAAIChatbot&&WSAAIChatbot.toggle()}viewChatHistory(){o.ajax({url:wsa_pro_admin.ajax_url,type:"POST",data:{action:"wsa_get_chat_history",nonce:wsa_pro_admin.nonce},success:e=>{e.success&&this.showChatHistoryModal(e.data)}})}showChatHistoryModal(e){e=`
                <div class="wsa-modal" id="wsa-chat-history-modal">
                    <div class="wsa-modal-content">
                        <div class="wsa-modal-header">
                            <h3>Chat History</h3>
                            <button class="wsa-modal-close">&times;</button>
                        </div>
                        <div class="wsa-modal-body">
                            <div class="wsa-chat-history">
                                ${e.map(e=>`
                                    <div class="wsa-chat-session">
                                        <div class="wsa-chat-date">${e.date}</div>
                                        <div class="wsa-chat-messages">
                                            ${e.messages.map(e=>`
                                                <div class="wsa-chat-message wsa-${e.type}">
                                                    ${e.content}
                                                </div>
                                            `).join("")}
                                        </div>
                                    </div>
                                `).join("")}
                            </div>
                        </div>
                    </div>
                </div>
            `;o("body").append(e),o("#wsa-chat-history-modal .wsa-modal-close, #wsa-chat-history-modal").on("click",function(e){e.target===this&&o("#wsa-chat-history-modal").remove()})}updateLocalhostMessage(){var e=o(".wsa-performance-analysis .notice-warning");e.length&&e.text().includes("localhost")&&(e.removeClass("notice-warning").addClass("notice-info"),e.html("<p><strong>ðŸš€ Pro Enhancement:</strong> Localhost detected! The Pro plugin will use Lighthouse simulation to provide realistic performance analysis for local development. For production analysis, deploy to a public server.</p>"))}initPersistedData(){var e=localStorage.getItem("wsa_last_performance_data");if(e)try{JSON.parse(e),o("#wsa-view-performance-report").show(),o("#wsa-performance-results")}catch(e){console.error("Error parsing persisted performance data:",e),localStorage.removeItem("wsa_last_performance_data")}}showPerformanceModal(i){var e=o("#wsa-performance-modal"),s=o("#wsa-modal-performance-content");if(e.length){localStorage.setItem("wsa_last_performance_data",JSON.stringify(i));let r="";if(i.report&&i.report.desktop&&i.report.desktop.error)r=(r+='<div class="notice notice-error"><p><strong>PageSpeed API Error:</strong></p>')+"<p>"+i.report.desktop.error+"</p></div>";else if(i&&(i.report||i.summary||i.desktop||i.mobile)){var n=i.report||i;let e=!1,s=!1,t=null,o=null;if(n.desktop&&n.desktop.scores?(e=!0,s=n.mobile&&n.mobile.scores,t=n.desktop.scores,o=s?n.mobile.scores:null):i.summary&&i.summary.scores&&(e=!!i.summary.scores.desktop,s=!!i.summary.scores.mobile,t=i.summary.scores.desktop,o=i.summary.scores.mobile),"lighthouse_simulation"!==i.source&&"lighthouse_simulation"!==n.source||(r=(r=(r=(r+='<div class="wsa-modal-simulation-badge">')+'<span class="dashicons dashicons-performance"></span><div class="wsa-modal-simulation-badge-text">')+"<strong>ðŸš€ Lighthouse Simulation Results</strong><p>Local development analysis completed. Deploy to a public server for full PageSpeed Insights data.</p>")+"</div></div>"),r+='<div class="wsa-performance-scores">',e){r=r+"<h5>Desktop Performance Scores:</h5>"+'<div class="wsa-score-grid">',Object.keys(t).forEach(e=>{var s=t[e];r=(r=(r+='<div class="wsa-score-item">')+"<strong>"+e.charAt(0).toUpperCase()+e.slice(1).replace("-"," ")+"</strong>")+'<span class="score-value" data-score="'+s.score+'">'+s.score+"/100</span></div>"}),r+="</div>";let a=n.desktop?.metrics||i.summary?.metrics?.desktop;a&&(r+='<h6>Desktop Core Web Vitals:</h6><div class="wsa-metrics-grid">',Object.keys(a).forEach(e=>{var s=a[e];s.displayValue&&(r=(r=(r+='<div class="wsa-metric-item">')+"<strong>"+e.replace(/-/g," ").replace(/\b\w/g,e=>e.toUpperCase())+"</strong>")+'<span class="metric-value">'+s.displayValue+"</span></div>")}),r+="</div>")}if(s){r=r+"<h5>Mobile Performance Scores:</h5>"+'<div class="wsa-score-grid">',Object.keys(o).forEach(e=>{var s=o[e];r=(r=(r+='<div class="wsa-score-item">')+"<strong>"+e.charAt(0).toUpperCase()+e.slice(1).replace("-"," ")+"</strong>")+'<span class="score-value" data-score="'+s.score+'">'+s.score+"/100</span></div>"}),r+="</div>";let a=n.mobile?.metrics||i.summary?.metrics?.mobile;a&&(r+='<h6>Mobile Core Web Vitals:</h6><div class="wsa-metrics-grid">',Object.keys(a).forEach(e=>{var s=a[e];s.displayValue&&(r=(r=(r+='<div class="wsa-metric-item">')+"<strong>"+e.replace(/-/g," ").replace(/\b\w/g,e=>e.toUpperCase())+"</strong>")+'<span class="metric-value">'+s.displayValue+"</span></div>")}),r+="</div>")}n=n.ai_insights||i.ai_insights;n&&n.content&&(r=(r+='<div class="wsa-ai-insights"><h5>ðŸ¤– AI Performance Recommendations</h5>')+'<div class="wsa-ai-content">'+n.content.replace(/\n/g,"<br>")+"</div></div>"),!e&&!s&&i.summary&&i.summary.scores&&(r+='<h5>Performance Scores:</h5><div class="wsa-score-grid">',Object.keys(i.summary.scores).forEach(e=>{var s=i.summary.scores[e];s&&void 0!==s.score&&(r=(r=(r+='<div class="wsa-score-item">')+"<strong>"+e.charAt(0).toUpperCase()+e.slice(1)+"</strong>")+'<span class="score-value" data-score="'+s.score+'">'+s.score+"/100</span></div>")}),r+="</div>"),r+="</div>"}else r+='<div class="notice notice-warning"><p>No performance data available.</p></div>';s.html(r),e.addClass("wsa-modal-open"),o("body").css("overflow","hidden"),this.bindModalEvents()}else console.error("Performance modal not found!")}showModalError(e){var s=o("#wsa-performance-modal");o("#wsa-modal-performance-content").html('<div class="notice notice-error"><p>'+e+"</p></div>"),s.addClass("wsa-modal-open"),o("body").css("overflow","hidden"),this.bindModalEvents()}closeModal(){o("#wsa-performance-modal").removeClass("wsa-modal-open"),o("body").css("overflow","")}bindModalEvents(){let s=this;o(".wsa-modal-close, #wsa-modal-close-btn").off("click.modal").on("click.modal",function(e){e.preventDefault(),s.closeModal()}),o("#wsa-run-new-analysis").off("click.modal").on("click.modal",function(e){e.preventDefault(),s.closeModal(),setTimeout(()=>{o("#wsa-run-pagespeed-analysis").click()},300)}),o(".wsa-modal-overlay").off("click.modal").on("click.modal",function(e){e.target===this&&s.closeModal()}),o(document).off("keydown.modal").on("keydown.modal",function(e){27===e.keyCode&&s.closeModal()})}testModalWithSampleData(){this.showPerformanceModal({report:{url:"//localhost:5500/wpsiteadvisor",desktop:{strategy:"desktop",scores:{performance:{score:75},accessibility:{score:85},"best-practices":{score:80},seo:{score:90}},metrics:{"first-contentful-paint":{displayValue:"1.5 s"},"largest-contentful-paint":{displayValue:"2.5 s"},"total-blocking-time":{displayValue:"320 ms"},"cumulative-layout-shift":{displayValue:"0.10"},"speed-index":{displayValue:"3.0 s"}}},mobile:{strategy:"mobile",scores:{performance:{score:65},accessibility:{score:85},"best-practices":{score:80},seo:{score:88}},metrics:{"first-contentful-paint":{displayValue:"2.0 s"},"largest-contentful-paint":{displayValue:"3.5 s"},"total-blocking-time":{displayValue:"420 ms"},"cumulative-layout-shift":{displayValue:"0.10"},"speed-index":{displayValue:"4.0 s"}}},ai_insights:{content:"Sample AI insights for testing..."},source:"lighthouse_simulation"}})}}o(document).ready(function(){o(".wsa-dashboard").length&&(window.WSAProIntegration=new e)})})(jQuery);